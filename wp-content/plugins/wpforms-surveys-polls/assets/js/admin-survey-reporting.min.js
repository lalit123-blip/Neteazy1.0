!function(o){"use strict";var s,l={settings:{fieldIDs:JSON.parse(wpforms_surveys.field_ids),fieldQueue:"",fieldData:{},charts:{},exportSelects:{}},init:function(){s=this.settings,Chart.defaults.global.defaultFontSize=14,Chart.plugins.register({beforeDraw:function(e){var t=e.chart.ctx;t.fillStyle="white",t.fillRect(0,0,e.chart.width,e.chart.height)}}),o(document).ready(l.ready),l.buildUIActions()},ready:function(){_.isEmpty(s.fieldIDs)||(s.fieldQueue=s.fieldIDs,_.isEmpty(wpforms_surveys_cache)?l.getFieldData():(s.fieldData=JSON.parse(wpforms_surveys_cache),l.generateReport()))},initExportChoices:function(){o(".survey-chart-export").each(function(){var e=o(this),t=e.data("id");s.exportSelects["export_"+t]=new Choices(e[0],{searchEnabled:!1,shouldSort:!1})})},buildUIActions:function(){o(document).on("click","#wpforms-survey-report .chart-toggle",function(e){e.preventDefault();var t=o(this),a=t.data("type"),r=t.hasClass("current"),i=t.parent(),n=i.data("field-id");r||(i.find(".current").removeClass("current"),t.addClass("current"),s.charts["chart_"+n].destroy(),s.charts["chart_hq_"+n].destroy(),l.generateChart(n,a,s.fieldData["field_"+n].chart.labels,s.fieldData["field_"+n].chart.data),l.generateChart(n,a,s.fieldData["field_"+n].chart.labels,s.fieldData["field_"+n].chart.data,!0))}),o(document).on("change","#wpforms-survey-preview-questions",function(){var e=o(this).val();s.fieldQueue=[],s.fieldData={},s.fieldQueue.push(e),o("#wpforms-survey-report").empty().prepend(wpforms_surveys.loader),l.getFieldData();var t={action:"wpforms_surveys_set_preview_field",nonce:wpforms_admin.nonce,field_id:e,form_id:wpforms_surveys.form_id};o.post(wpforms_admin.ajax_url,t)}),o(document).on("change",".survey-chart-export",function(){var e,t=o(this),a=t.data("id");if("jpg"===t.val())e=o(" #chart-"+a+"-hq")[0].toDataURL("image/jpeg",1),o("#chart-"+a+"-download").attr("href",e),document.getElementById("chart-"+a+"-download").click();else if("pdf"===t.val()){e=o(" #chart-"+a+"-hq")[0].toDataURL("image/jpeg",1);var r={pageSize:"LETTER",content:[{text:s.fieldData["field_"+a].question,fontSize:20,margin:[0,0,0,35]},{image:e,width:530}]};pdfMake.createPdf(r).download("chart-field-"+a+".pdf")}else"print"===t.val()&&window.open(wpforms_surveys.print+"&field_id="+a);"1"!==t.val()&&s.exportSelects["export_"+a].setValueByChoice("1")}),o(document).on("click",".form-details-print-survey-report",function(e){e.preventDefault(),window.open(o(this).attr("href"))}),o(document).on("click","#wpforms-survey-print-close",function(e){e.preventDefault(),window.close()}),o(document).on("click","#wpforms-survey-print",function(e){e.preventDefault(),window.print()}),o(document).on("click","#wpforms-survey-print-preview .question-toggle",function(e){e.preventDefault();var t=o(this),a=t.parent();t.find("i").toggleClass("fa-chevron-down fa-chevron-right"),a.toggleClass("no-print").find(".chart-area, .table-wrap, .stats, .no-answers").toggle()})},getFieldData:function(){var t=_.first(s.fieldQueue),e={action:"wpforms_surveys_field_data",nonce:wpforms_admin.nonce,form_id:wpforms_surveys.form_id,field_id:t,entry_count:wpforms_surveys.entry_count};o.post(wpforms_admin.ajax_url,e,function(e){e.success&&(WPFormsAdmin.debug(e.data),s.fieldData["field_"+e.data.id]=e.data,s.fieldQueue=_.without(s.fieldQueue,t),_.isEmpty(s.fieldQueue)?(l.cacheFieldData(),l.generateReport()):l.getFieldData())})},cacheFieldData:function(){var e={action:"wpforms_surveys_cache_fields",nonce:wpforms_admin.nonce,field_data:JSON.stringify(s.fieldData),form_id:wpforms_surveys.form_id,field_id:wpforms_surveys.field_id,entry_count:wpforms_surveys.entry_count};o.post(wpforms_admin.ajax_url,e)},generateReport:function(){o("#wpforms-survey-loading").remove();var e=wp.template("wpforms-question-results");o("#wpforms-survey-report").append(e(s.fieldData)),o.each(s.fieldData,function(e,t){_.isEmpty(t.chart.data)||(l.generateChart(t.id,t.chart.default,t.chart.labels,t.chart.data),l.generateChart(t.id,t.chart.default,t.chart.labels,t.chart.data,!0))}),o(".wpforms-table-sorting").stupidtable(),l.initExportChoices(),"list"===wpforms_surveys.type&&o("#wpforms-survey-preview .btn-wrap").show()},generateChart:function(a,e,t,r,i){var n=!1;i=i||!1;"bar"===e?n={type:"bar",data:{labels:t,datasets:[{label:"Data",hoverBackgroundColor:"#2b8fd2",backgroundColor:"rgba(215, 215, 215, 0.65)",data:r}]},options:{responsive:!i,maintainAspectRatio:!1,legend:{display:!1},tooltips:{callbacks:{title:function(e,t){return t.labels[e[0].index]},label:function(e){return e.yLabel+"% ("+s.fieldData["field_"+a].chart.totals[e.index]+")"}}},scales:{xAxes:[{gridLines:{display:!1},ticks:{fontSize:i?20:14,callback:function(e){return"string"==typeof e&&20<e.length?e.substring(0,20)+"...":e}}}],yAxes:[{ticks:{min:0,max:100,stepSize:20,fontColor:"#999999",fontSize:i?20:11,callback:function(e){return e+"%"}}}]}}}:"bar-h"===e?n={type:"horizontalBar",data:{labels:t,datasets:[{label:"Data",hoverBackgroundColor:"#2b8fd2",backgroundColor:"rgba(215, 215, 215, 0.65)",data:r}]},options:{responsive:!i,maintainAspectRatio:!1,legend:{display:!1},tooltips:{callbacks:{title:function(e,t){return t.labels[e[0].index]},label:function(e){return e.xLabel+"% ("+s.fieldData["field_"+a].chart.totals[e.index]+")"}}},scales:{xAxes:[{ticks:{min:0,max:100,fontColor:"#999999",fontSize:i?20:11,callback:function(e){return e+"%"}}}],yAxes:[{gridLines:{display:!1},ticks:{fontSize:i?20:14,callback:function(e){return"string"==typeof e&&20<e.length?e.substring(0,20)+"...":e}}}]}}}:"pie"===e?n={type:"pie",data:{labels:t,datasets:[{hoverBackgroundColor:"#2b8fd2",data:r,backgroundColor:randomColor({luminosity:"light",count:r.length})}]},options:{responsive:!i,maintainAspectRatio:!1,legend:{position:"right",labels:{fontSize:i?20:14,padding:15,generateLabels:function(f){var u=f.data;return u.labels.length&&u.datasets.length?u.labels.map(function(e,t){var a=f.getDatasetMeta(0),r=u.datasets[0],i=a.data[t],n=i&&i.custom||{},o=Chart.helpers.valueAtIndexOrDefault,s=f.options.elements.arc,l=n.backgroundColor?n.backgroundColor:o(r.backgroundColor,t,s.backgroundColor),d=n.borderColor?n.borderColor:o(r.borderColor,t,s.borderColor),c=n.borderWidth?n.borderWidth:o(r.borderWidth,t,s.borderWidth);return 20<e.length&&(e=e.substring(0,20)+"..."),{text:e,fillStyle:l,strokeStyle:d,lineWidth:c,hidden:isNaN(r.data[t])||a.data[t].hidden,index:t}}):[]}}},tooltips:{callbacks:{label:function(e,t){return t.labels[e.index]+" - "+t.datasets[0].data[e.index]+"% ("+s.fieldData["field_"+a].chart.totals[e.index]+")"}}}}}:"line"===e&&(n={type:"line",data:{labels:t,datasets:[{label:"Data",borderColor:"#2b8fd2",backgroundColor:"rgba(215, 215, 215, 0.65)",fill:!1,data:r}]},options:{responsive:!i,maintainAspectRatio:!1,legend:{display:!1},tooltips:{callbacks:{title:function(e,t){return t.labels[e[0].index]},label:function(e){return e.yLabel+"% ("+s.fieldData["field_"+a].chart.totals[e.index]+")"}}},scales:{xAxes:[{gridLines:{display:!1},ticks:{fontSize:i?20:14,callback:function(e){return"string"==typeof e&&20<e.length?e.substring(0,20)+"...":e}}}],yAxes:[{ticks:{min:0,max:100,stepSize:20,fontColor:"#999999",fontSize:i?20:11,callback:function(e){return e+"%"}}}]}}}),n&&(i?s.charts["chart_hq_"+a]=new Chart("chart-"+a+"-hq",n):s.charts["chart_"+a]=new Chart("chart-"+a,n))}};l.init()}(jQuery);